{% extends "base.html" %}
{% block title %}GestiÃ³n de Citas{% endblock %}
{% block content %}
<div class="dashboard-header" style="margin-bottom: 30px;">
  <div class="welcome-message">
    <h1>ğŸ‘¥ GestiÃ³n de Citas</h1>
    <p class="welcome-text" style="color: white;">AdministraciÃ³n y seguimiento de todas las citas</p>
  </div>
</div>

<!-- Filtros -->
<div class="card">
  <h3>ğŸ” Filtros de BÃºsqueda</h3>
  
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
    <div>
      <label for="vistaFiltro">Vista:</label>
      <select id="vistaFiltro" onchange="aplicarFiltros()" class="form-control">
        <option value="pendientes" {% if vista_actual == 'pendientes' %}selected{% endif %}>â³ Pendientes</option>
        <option value="hoy" {% if vista_actual == 'hoy' %}selected{% endif %}>ğŸ“… Hoy</option>
        <option value="semana" {% if vista_actual == 'semana' %}selected{% endif %}>ğŸ“† Esta Semana</option>
        <option value="pasadas" {% if vista_actual == 'pasadas' %}selected{% endif %}>ğŸ“‹ Pasadas</option>
        <option value="sin_autorizar" {% if vista_actual == 'sin_autorizar' %}selected{% endif %}>ğŸ“‹ Sin Autorizar</option>
        <option value="autorizadas" {% if vista_actual == 'autorizadas' %}selected{% endif %}>âœ… Autorizadas</option>
        <option value="">ğŸ“‹ Todas</option>
      </select>
    </div>
    
    {% if rol in ['admin', 'coordinadora'] %}
    <div>
      <label for="profesionalFiltro">Profesional:</label>
      <select id="profesionalFiltro" onchange="aplicarFiltros()" class="form-control">
        <option value="">Todos</option>
        {% for prof in profesionales %}
        <option value="{{ prof.id }}" {% if profesional_filtro == prof.id|string %}selected{% endif %}>
          {{ prof.nombre_completo }}
        </option>
        {% endfor %}
      </select>
    </div>
    {% endif %}
    
    <div>
      <label for="estadoFiltro">Estado:</label>
      <select id="estadoFiltro" onchange="aplicarFiltros()" class="form-control">
        <option value="">Todos</option>
        <option value="agendada" {% if estado_filtro == 'agendada' %}selected{% endif %}>â³ Agendada</option>
        <option value="confirmada" {% if estado_filtro == 'confirmada' %}selected{% endif %}>âœ… Confirmada</option>
        <option value="atendida" {% if estado_filtro == 'atendida' %}selected{% endif %}>ğŸ‰ Atendida</option>
        <option value="no_atendida" {% if estado_filtro == 'no_atendida' %}selected{% endif %}>âš ï¸ No Atendida</option>
        <option value="cancelada" {% if estado_filtro == 'cancelada' %}selected{% endif %}>âŒ Cancelada</option>
      </select>
    </div>
    
    <!-- NUEVO: Filtro de autorizaciÃ³n para administraciÃ³n -->
    {% if rol in ['admin', 'administracion', 'coordinadora'] %}
    <div>
      <label for="autorizacionFiltro">AutorizaciÃ³n:</label>
      <select id="autorizacionFiltro" onchange="aplicarFiltros()" class="form-control">
        <option value="">Todas</option>
        <option value="pendientes" {% if autorizacion_filtro == 'pendientes' %}selected{% endif %}>â³ Pendientes</option>
        <option value="autorizadas" {% if autorizacion_filtro == 'autorizadas' %}selected{% endif %}>âœ… Autorizadas</option>
      </select>
    </div>
    {% endif %}
  </div>
</div>

<!-- Resumen -->
<div class="card">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h3>ğŸ“‹ Citas Encontradas: {{ citas|length }}</h3>
    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
      <span style="background: #fff3cd; color: #856404; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">
        â³ Agendadas: {{ citas|selectattr('estado', 'equalto', 'agendada')|list|length }}
      </span>
      <span style="background: #d4edda; color: #155724; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">
        âœ… Confirmadas: {{ citas|selectattr('estado', 'equalto', 'confirmada')|list|length }}
      </span>
      <span style="background: #d1ecf1; color: #0c5460; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">
        ğŸ‰ Atendidas: {{ citas|selectattr('estado', 'equalto', 'atendida')|list|length }}
      </span>
      <span style="background: #f8d7da; color: #721c24; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">
        âŒ Canceladas: {{ citas|selectattr('estado', 'equalto', 'cancelada')|list|length }}
      </span>
      {% if rol in ['admin', 'administracion'] %}
      <span style="background: #e2e3e5; color: #383d41; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">
        ğŸ“‹ Sin Autorizar: {{ citas|selectattr('cita_autorizada', 'equalto', 0)|selectattr('estado', 'in', ['agendada', 'confirmada'])|list|length }}
      </span>
      {% endif %}
    </div>
  </div>

  {% if citas %}
  <div class="table-container">
    <table class="table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Fecha y Hora</th>
          <th>Familia</th>
          <th>Paciente</th>
          {% if rol in ['admin', 'coordinadora'] %}
          <th>Profesional</th>
          {% endif %}
          <th>Tipo</th>
          <th>Estado</th>
          <th>AutorizaciÃ³n</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for cita in citas %}
        <tr style="border-left: 4px solid {{ cita.color_calendario }};">
          <td><strong>#{{ cita.id }}</strong></td>
          <td>
            <strong>{{ cita.fecha_hora[:16] }}</strong><br>
            <small style="color: #666;">{{ cita.duracion }} min</small>
          </td>
          <td>
            <strong>{{ cita.familia_nombre }}</strong><br>
            <small style="color: #666;">{{ cita.telefono_principal if cita.telefono_principal else 'Sin telÃ©fono' }}</small>
          </td>
          <td>{{ cita.nombre_hijo_hija }}</td>
          {% if rol in ['admin', 'coordinadora'] %}
          <td>
            <span style="color: {{ cita.color_calendario }}; font-weight: 600;">
              {{ cita.profesional_nombre }}
            </span>
          </td>
          {% endif %}
          <td>
            {% if cita.tipo_consulta == 'virtual' %}
            <span style="background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">
              ğŸ’» Virtual
            </span>
            {% elif cita.tipo_consulta == 'domicilio' %}
            <span style="background: #f3e5f5; color: #7b1fa2; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">
              ğŸ  Domicilio
            </span>
            {% else %}
            <span style="background: #e8f5e8; color: #2e7d32; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">
              ğŸ¢ Presencial
            </span>
            {% endif %}
          </td>
          <td>
            {% if cita.estado == 'agendada' %}
            <span style="background: #fff3cd; color: #856404; padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
              â³ Agendada
            </span>
            {% elif cita.estado == 'confirmada' %}
            <span style="background: #d4edda; color: #155724; padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
              âœ… Confirmada
            </span>
            {% elif cita.estado == 'atendida' %}
            <span style="background: #d1ecf1; color: #0c5460; padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
              ğŸ‰ Atendida
            </span>
            {% elif cita.estado == 'no_atendida' %}
            <span style="background: #f8d7da; color: #721c24; padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
              âš ï¸ No Atendida
            </span>
            {% elif cita.estado == 'cancelada' %}
            <span style="background: #f8d7da; color: #721c24; padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
              âŒ Cancelada
            </span>
            {% endif %}
          </td>
          <td>
            {% if cita.cita_autorizada %}
            <span style="background: #d4edda; color: #155724; padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
              âœ… Autorizada
            </span>
            {% else %}
            <span style="background: #fff3cd; color: #856404; padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
              â³ Pendiente
            </span>
            {% endif %}
          </td>
          <td>
            <div style="display: flex; gap: 5px; flex-wrap: wrap;">
              <button type="button" class="btn small success" 
                      onclick="mostrarModalEstado({{ cita.id }}, '{{ cita.estado }}', {{ 1 if cita.cita_autorizada else 0 }})"
                      {% if cita.estado in ['atendida', 'cancelada'] %}disabled{% endif %}>
                âœï¸ Estado
              </button>
              {% if cita.motivo_consulta or cita.notas %}
              <button type="button" class="btn small info" 
                      onclick="mostrarDetalles({{ cita.id }}, '{{ cita.motivo_consulta }}', '{{ cita.notas }}')">
                ğŸ“‹ Ver
              </button>
              {% endif %}
              {% if rol in ['admin', 'administracion'] and not cita.cita_autorizada and cita.estado in ['agendada', 'confirmada'] %}
              <button type="button" class="btn small warning" 
                      onclick="autorizarCita({{ cita.id }})">
                ğŸ“‹ Autorizar
              </button>
              {% endif %}
              <!-- NUEVO: BotÃ³n para eliminar cita -->
              {% if rol in ['admin', 'coordinadora'] %}
              <button type="button" class="btn small danger" 
                      onclick="eliminarCita({{ cita.id }})">
                ğŸ—‘ï¸ Eliminar
              </button>
              {% endif %}
              {% if rol in ['admin', 'coordinadora'] %}
              <a href="{{ url_for('calendario') }}" class="btn small primary">
                ğŸ“… Calendario
              </a>
              {% endif %}
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="empty-state">
    <div class="empty-icon">ğŸ“­</div>
    <h3>No se encontraron citas</h3>
    <p>No hay citas que coincidan con los filtros aplicados.</p>
    <p>Intenta ajustar los criterios de bÃºsqueda.</p>
  </div>
  {% endif %}
</div>

<!-- Modales -->
<div id="estadoModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3>Cambiar Estado de Cita</h3>
    <form id="estadoForm" method="post">
      <input type="hidden" name="cita_id" id="citaId">
      <div class="form-group">
        <label for="nuevo_estado">Nuevo Estado:</label>
        <select name="estado" id="nuevo_estado" required>
          <option value="agendada">â³ Agendada</option>
          <option value="confirmada">âœ… Confirmada</option>
          <option value="atendida" id="opcionAtendida">ğŸ‰ Atendida</option>
          <option value="no_atendida">âš ï¸ No Atendida</option>
          <option value="cancelada">âŒ Cancelada</option>
        </select>
        <div id="alertaAutorizacion" style="display: none; background: #fff3cd; color: #856404; padding: 10px; border-radius: 6px; margin-top: 10px; font-size: 0.9rem;">
          âš ï¸ Solo puede marcar como atendida si la cita estÃ¡ autorizada
        </div>
      </div>
      <div class="form-group">
        <label for="notas_estado">Notas (opcional):</label>
        <textarea name="notas" id="notas_estado" rows="3" placeholder="Observaciones sobre el cambio de estado..." maxlength="500"></textarea>
      </div>
      <button type="submit" class="btn primary">Actualizar Estado</button>
    </form>
  </div>
</div>

<div id="detallesModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3>Detalles de la Cita</h3>
    <div id="detallesContent"></div>
  </div>
</div>

<style>
.form-control {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 14px;
}

.table-container {
  overflow-x: auto;
}

.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
}

.modal-content {
  background-color: white;
  margin: 10% auto;
  padding: 25px;
  border-radius: 12px;
  width: 90%;
  max-width: 500px;
  position: relative;
}

.close {
  position: absolute;
  right: 20px;
  top: 15px;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
  color: #666;
}

.close:hover {
  color: #000;
}

.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: #666;
}

.empty-icon {
  font-size: 4rem;
  margin-bottom: 20px;
  opacity: 0.5;
}

.btn.small {
  padding: 6px 12px;
  font-size: 0.8rem;
}

.btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
</style>

<script>
let citaAutorizadaActual = false;

function aplicarFiltros() {
  const vista = document.getElementById('vistaFiltro').value;
  const profesional = document.getElementById('profesionalFiltro')?.value || '';
  const estado = document.getElementById('estadoFiltro').value;
  const autorizacion = document.getElementById('autorizacionFiltro')?.value || '';
  
  let url = '{{ url_for("gestion_citas") }}?';
  const params = [];
  
  if (vista) params.push(`vista=${vista}`);
  if (profesional) params.push(`profesional=${profesional}`);
  if (estado) params.push(`estado=${estado}`);
  if (autorizacion) params.push(`autorizacion=${autorizacion}`);
  
  window.location.href = url + params.join('&');
}

function mostrarModalEstado(citaId, estadoActual, citaAutorizada) {
  document.getElementById('citaId').value = citaId;
  document.getElementById('nuevo_estado').value = estadoActual;
  citaAutorizadaActual = citaAutorizada;
  
  // Mostrar/ocultar alerta segÃºn autorizaciÃ³n
  const alertaAutorizacion = document.getElementById('alertaAutorizacion');
  const opcionAtendida = document.getElementById('opcionAtendida');
  
  if (!citaAutorizada) {
    alertaAutorizacion.style.display = 'block';
    opcionAtendida.disabled = true;
    opcionAtendida.style.opacity = '0.5';
  } else {
    alertaAutorizacion.style.display = 'none';
    opcionAtendida.disabled = false;
    opcionAtendida.style.opacity = '1';
  }
  
  document.getElementById('estadoModal').style.display = 'block';
}

function autorizarCita(citaId) {
  if (confirm('Â¿EstÃ¡ seguro de que desea autorizar esta cita?\n\nLa profesional podrÃ¡ marcar la cita como atendida.')) {
    fetch(`/citas/${citaId}/autorizar`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      }
    }).then(response => {
      if (response.ok) {
        location.reload();
      } else {
        alert('Error al autorizar la cita');
      }
    });
  }
}

// NUEVA FUNCIÃ“N: Eliminar cita
function eliminarCita(citaId) {
  if (confirm('Â¿EstÃ¡ seguro de que desea ELIMINAR esta cita?\n\nâš ï¸ Esta acciÃ³n no se puede deshacer y eliminarÃ¡ permanentemente la cita.')) {
    fetch(`/citas/${citaId}/eliminar`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      }
    }).then(response => {
      if (response.ok) {
        location.reload();
      } else {
        alert('Error al eliminar la cita');
      }
    });
  }
}

function mostrarDetalles(citaId, motivo, notas) {
  let contenido = '';
  
  if (motivo) {
    contenido += `<p><strong>Motivo de consulta:</strong><br>${motivo}</p>`;
  }
  
  if (notas) {
    contenido += `<p><strong>Notas adicionales:</strong><br>${notas}</p>`;
  }
  
  if (!motivo && !notas) {
    contenido = '<p>No hay informaciÃ³n adicional para esta cita.</p>';
  }
  
  document.getElementById('detallesContent').innerHTML = contenido;
  document.getElementById('detallesModal').style.display = 'block';
}

// Cerrar modales
document.querySelectorAll('.close').forEach(closeBtn => {
  closeBtn.onclick = function() {
    this.closest('.modal').style.display = 'none';
  };
});

window.onclick = function(event) {
  if (event.target.classList.contains('modal')) {
    event.target.style.display = 'none';
  }
}

// Enviar formulario de estado
document.getElementById('estadoForm').onsubmit = function(e) {
  e.preventDefault();
  
  // Validar que si es profesional y quiere marcar como atendida, estÃ© autorizada
  const nuevoEstado = document.getElementById('nuevo_estado').value;
  const rol = '{{ rol }}';
  
  if (rol === 'profesional' && nuevoEstado === 'atendida' && !citaAutorizadaActual) {
    alert('No puede marcar la cita como atendida hasta que sea autorizada por administraciÃ³n');
    return false;
  }
  
  const formData = new FormData(this);
  
  fetch('/citas/' + document.getElementById('citaId').value + '/actualizar_estado', {
    method: 'POST',
    body: formData
  }).then(response => {
    if (response.ok) {
      document.getElementById('estadoModal').style.display = 'none';
      location.reload();
    }
  });
}

// ActualizaciÃ³n automÃ¡tica de contadores en esta pÃ¡gina
document.addEventListener('DOMContentLoaded', function() {
  // Configurar actualizaciÃ³n cada 15 segundos para esta pÃ¡gina
  setInterval(() => {
    if (typeof actualizarTodosLosContadores === 'function') {
      actualizarTodosLosContadores();
    }
  }, 15000);
});
</script>
{% endblock %}

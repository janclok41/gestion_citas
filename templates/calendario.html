{% extends "base.html" %}
{% block title %}Calendario de Citas{% endblock %}
{% block content %}
<div class="dashboard-header" style="margin-bottom: 30px;">
  <div class="welcome-message">
    <h1>ğŸ“… Calendario de Citas</h1>
    <p class="welcome-text" style="color: white;">GestiÃ³n y visualizaciÃ³n de citas programadas</p>
  </div>
</div>

<div class="card">
  <div class="card-header">
    <h3>Agendar Nueva Cita</h3>
    <p>Complete los datos para programar una nueva cita</p>
  </div>
  
  <form action="{{ url_for('agendar_cita') }}" method="post" class="formulario">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
      <div class="form-group">
        <label for="familia_id">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Familia *</label>
        <select name="familia_id" id="familia_id" required>
          <option value="">Seleccionar familia...</option>
          {% for familia in familias %}
          <option value="{{ familia.id }}">{{ familia.nombres_apellidos }} - {{ familia.nombre_hijo_hija }}</option>
          {% endfor %}
        </select>
      </div>
      
      <div class="form-group">
        <label for="profesional_id">ğŸ‘©â€âš•ï¸ Profesional *</label>
        <select name="profesional_id" id="profesional_id" required 
                {% if rol == 'profesional' %}disabled{% endif %}>
          <option value="">Seleccionar profesional...</option>
          {% for prof in profesionales %}
          <option value="{{ prof.id }}" 
                  {% if rol == 'profesional' and prof.id == session.user_id %}selected{% endif %}>
            {{ prof.nombre_completo }}
          </option>
          {% endfor %}
        </select>
        {% if rol == 'profesional' %}
        <input type="hidden" name="profesional_id" value="{{ session.user_id }}">
        {% endif %}
      </div>
      
      <div class="form-group">
        <label for="fecha_hora">ğŸ“… Fecha y Hora *</label>
        <input type="datetime-local" name="fecha_hora" id="fecha_hora" required>
      </div>
      
      <div class="form-group">
        <label for="duracion">â±ï¸ DuraciÃ³n (minutos)</label>
        <select name="duracion" id="duracion">
          <option value="30">30 minutos</option>
          <option value="45">45 minutos</option>
          <option value="60" selected>60 minutos</option>
          <option value="90">90 minutos</option>
          <option value="120">120 minutos</option>
        </select>
      </div>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
      <div class="form-group">
        <label for="tipo_consulta">ğŸ’» Tipo de Consulta</label>
        <select name="tipo_consulta" id="tipo_consulta">
          <option value="presencial">Presencial</option>
          <option value="virtual">Virtual</option>
          <option value="domicilio">Domicilio</option>
        </select>
      </div>
      
      <div class="form-group" style="grid-column: span 2;">
        <label for="motivo_consulta">ğŸ“ Motivo de Consulta</label>
        <input type="text" name="motivo_consulta" id="motivo_consulta" placeholder="Breve descripciÃ³n del motivo de la consulta..." maxlength="200">
      </div>
    </div>
    
    <div class="form-group">
      <label for="notas">ğŸ“‹ Notas Adicionales</label>
      <textarea name="notas" id="notas" rows="3" placeholder="Observaciones o informaciÃ³n adicional..." maxlength="500"></textarea>
    </div>
    
    <button type="submit" class="btn primary">
      <span style="margin-right: 8px;">âœ…</span>
      Agendar Cita
    </button>
  </form>
</div>

<div class="card">
  <div class="card-header">
    <h3>Citas Programadas</h3>
    <p>Lista de todas las citas agendadas en el sistema</p>
  </div>
  
  {% if citas %}
  <div class="table-container">
    <table class="table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Fecha y Hora</th>
          <th>Familia</th>
          <th>Paciente</th>
          <th>Profesional</th>
          <th>Tipo</th>
          <th>Estado</th>
          <th>AutorizaciÃ³n</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for cita in citas %}
        <tr style="border-left: 4px solid {{ cita.color_calendario }};">
          <td><strong>#{{ cita.id }}</strong></td>
          <td>
            <strong>{{ cita.fecha_hora[:16] }}</strong><br>
            <small style="color: #666;">{{ cita.duracion }} min</small>
          </td>
          <td>
            <strong>{{ cita.familia_nombre }}</strong><br>
            <small style="color: #666;">{{ cita.telefono_principal }}</small>
          </td>
          <td>{{ cita.nombre_hijo_hija }}</td>
          <td>
            <span style="color: {{ cita.color_calendario }}; font-weight: 600;">
              {{ cita.profesional_nombre }}
            </span>
          </td>
          <td>
            {% if cita.tipo_consulta == 'virtual' %}
            <span style="background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">
              ğŸ’» Virtual
            </span>
            {% elif cita.tipo_consulta == 'domicilio' %}
            <span style="background: #f3e5f5; color: #7b1fa2; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">
              ğŸ  Domicilio
            </span>
            {% else %}
            <span style="background: #e8f5e8; color: #2e7d32; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">
              ğŸ¢ Presencial
            </span>
            {% endif %}
          </td>
          <td>
            {% if cita.estado == 'agendada' %}
            <span style="background: #fff3cd; color: #856404; padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
              â³ Agendada
            </span>
            {% elif cita.estado == 'confirmada' %}
            <span style="background: #d4edda; color: #155724; padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
              âœ… Confirmada
            </span>
            {% elif cita.estado == 'atendida' %}
            <span style="background: #d1ecf1; color: #0c5460; padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
              ğŸ‰ Atendida
            </span>
            {% elif cita.estado == 'cancelada' %}
            <span style="background: #f8d7da; color: #721c24; padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
              âŒ Cancelada
            </span>
            {% endif %}
          </td>
          <td>
            {% if cita.cita_autorizada %}
            <span style="background: #d4edda; color: #155724; padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
              âœ… Autorizada
            </span>
            {% else %}
            <span style="background: #fff3cd; color: #856404; padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
              â³ Pendiente
            </span>
            {% endif %}
          </td>
          <td>
            <div style="display: flex; gap: 5px; flex-wrap: wrap;">
              <button type="button" class="btn small success" 
                      onclick="mostrarModalEstado({{ cita.id }}, '{{ cita.estado }}', {{ 1 if cita.cita_autorizada else 0 }})"
                      {% if cita.estado in ['atendida', 'cancelada'] %}disabled{% endif %}>
                âœï¸ Estado
              </button>
              {% if cita.motivo_consulta or cita.notas %}
              <button type="button" class="btn small info" 
                      onclick="mostrarDetalles({{ cita.id }}, '{{ cita.motivo_consulta }}', '{{ cita.notas }}')">
                ğŸ“‹ Ver
              </button>
              {% endif %}
              {% if rol in ['admin', 'administracion'] and not cita.cita_autorizada and cita.estado in ['agendada', 'confirmada'] %}
              <button type="button" class="btn small warning" 
                      onclick="autorizarCita({{ cita.id }})">
                ğŸ“‹ Autorizar
              </button>
              {% endif %}
              <!-- NUEVO: BotÃ³n para eliminar cita -->
              {% if rol in ['admin', 'coordinadora'] %}
              <button type="button" class="btn small danger" 
                      onclick="eliminarCita({{ cita.id }})">
                ğŸ—‘ï¸ Eliminar
              </button>
              {% endif %}
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="empty-state">
    <div class="empty-icon">ğŸ“…</div>
    <h3>No hay citas programadas</h3>
    <p>Comienza agendando una nueva cita usando el formulario superior.</p>
  </div>
  {% endif %}
</div>

<!-- Modal para cambiar estado -->
<div id="estadoModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3>Cambiar Estado de Cita</h3>
    <form id="estadoForm" method="post">
      <input type="hidden" name="cita_id" id="citaId">
      <div class="form-group">
        <label for="nuevo_estado">Nuevo Estado:</label>
        <select name="estado" id="nuevo_estado" required>
          <option value="agendada">â³ Agendada</option>
          <option value="confirmada">âœ… Confirmada</option>
          <option value="atendida" id="opcionAtendida">ğŸ‰ Atendida</option>
          <option value="no_atendida">âš ï¸ No Atendida</option>
          <option value="cancelada">âŒ Cancelada</option>
        </select>
        <div id="alertaAutorizacion" style="display: none; background: #fff3cd; color: #856404; padding: 10px; border-radius: 6px; margin-top: 10px; font-size: 0.9rem;">
          âš ï¸ Solo puede marcar como atendida si la cita estÃ¡ autorizada
        </div>
      </div>
      <div class="form-group">
        <label for="notas_estado">Notas (opcional):</label>
        <textarea name="notas" id="notas_estado" rows="3" placeholder="Observaciones sobre el cambio de estado..." maxlength="500"></textarea>
      </div>
      <button type="submit" class="btn primary">Actualizar Estado</button>
    </form>
  </div>
</div>

<!-- Modal para ver detalles -->
<div id="detallesModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3>Detalles de la Cita</h3>
    <div id="detallesContent">
      <!-- Los detalles se cargarÃ¡n aquÃ­ -->
    </div>
  </div>
</div>

<style>
.formulario {
  max-width: 100%;
}

.table-container {
  overflow-x: auto;
}

.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
}

.modal-content {
  background-color: white;
  margin: 10% auto;
  padding: 25px;
  border-radius: 12px;
  width: 90%;
  max-width: 500px;
  position: relative;
}

.close {
  position: absolute;
  right: 20px;
  top: 15px;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
  color: #666;
}

.close:hover {
  color: #000;
}

.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: #666;
}

.empty-icon {
  font-size: 4rem;
  margin-bottom: 20px;
  opacity: 0.5;
}

.empty-state h3 {
  color: #495057;
  margin-bottom: 10px;
}

.btn.small {
  padding: 6px 12px;
  font-size: 0.8rem;
}

.btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

@media (max-width: 768px) {
  .modal-content {
    margin: 5% auto;
    width: 95%;
    padding: 20px;
  }
}
</style>

<script>
let citaAutorizadaActual = false;

function mostrarModalEstado(citaId, estadoActual, citaAutorizada) {
  document.getElementById('citaId').value = citaId;
  document.getElementById('nuevo_estado').value = estadoActual;
  citaAutorizadaActual = citaAutorizada;
  
  // Mostrar/ocultar alerta segÃºn autorizaciÃ³n
  const alertaAutorizacion = document.getElementById('alertaAutorizacion');
  const opcionAtendida = document.getElementById('opcionAtendida');
  
  if (!citaAutorizada) {
    alertaAutorizacion.style.display = 'block';
    opcionAtendida.disabled = true;
    opcionAtendida.style.opacity = '0.5';
  } else {
    alertaAutorizacion.style.display = 'none';
    opcionAtendida.disabled = false;
    opcionAtendida.style.opacity = '1';
  }
  
  document.getElementById('estadoModal').style.display = 'block';
}

function autorizarCita(citaId) {
  if (confirm('Â¿EstÃ¡ seguro de que desea autorizar esta cita?\n\nLa profesional podrÃ¡ marcar la cita como atendida.')) {
    fetch(`/citas/${citaId}/autorizar`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      }
    }).then(response => {
      if (response.ok) {
        location.reload();
      } else {
        alert('Error al autorizar la cita');
      }
    });
  }
}

// NUEVA FUNCIÃ“N: Eliminar cita
function eliminarCita(citaId) {
  if (confirm('Â¿EstÃ¡ seguro de que desea ELIMINAR esta cita?\n\nâš ï¸ Esta acciÃ³n no se puede deshacer y eliminarÃ¡ permanentemente la cita.')) {
    fetch(`/citas/${citaId}/eliminar`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      }
    }).then(response => {
      if (response.ok) {
        location.reload();
      } else {
        alert('Error al eliminar la cita');
      }
    });
  }
}

function mostrarDetalles(citaId, motivo, notas) {
  let contenido = '';
  
  if (motivo) {
    contenido += `<p><strong>Motivo de consulta:</strong><br>${motivo}</p>`;
  }
  
  if (notas) {
    contenido += `<p><strong>Notas adicionales:</strong><br>${notas}</p>`;
  }
  
  if (!motivo && !notas) {
    contenido = '<p>No hay informaciÃ³n adicional para esta cita.</p>';
  }
  
  document.getElementById('detallesContent').innerHTML = contenido;
  document.getElementById('detallesModal').style.display = 'block';
}

// Cerrar modales
document.querySelectorAll('.close').forEach(closeBtn => {
  closeBtn.onclick = function() {
    this.closest('.modal').style.display = 'none';
  };
});

// Cerrar modal al hacer click fuera
window.onclick = function(event) {
  if (event.target.classList.contains('modal')) {
    event.target.style.display = 'none';
  }
}

// Enviar formulario de estado
document.getElementById('estadoForm').onsubmit = function(e) {
  e.preventDefault();
  
  // Validar que si es profesional y quiere marcar como atendida, estÃ© autorizada
  const nuevoEstado = document.getElementById('nuevo_estado').value;
  const rol = '{{ rol }}';
  
  if (rol === 'profesional' && nuevoEstado === 'atendida' && !citaAutorizadaActual) {
    alert('No puede marcar la cita como atendida hasta que sea autorizada por administraciÃ³n');
    return false;
  }
  
  const formData = new FormData(this);
  
  fetch('/citas/' + document.getElementById('citaId').value + '/actualizar_estado', {
    method: 'POST',
    body: formData
  }).then(response => {
    if (response.ok) {
      document.getElementById('estadoModal').style.display = 'none';
      location.reload();
    }
  });
}

// Configurar fecha mÃ­nima en el datetime-local (hoy)
document.getElementById('fecha_hora').min = new Date().toISOString().slice(0,16);
</script>
{% endblock %}
